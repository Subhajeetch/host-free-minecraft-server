<!DOCTYPE html>
<html>

<head>
    <title>Minecraft Crossplay Server Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .status-card {
            text-align: center;
            padding: 30px;
            background: rgba(0, 0, 0, 0.3);
        }

        .status-indicator {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            transition: all 0.3s ease;
        }

        .status-offline {
            background: #f44336;
        }

        .status-starting {
            background: #ff9800;
            animation: pulse 2s infinite;
        }

        .status-online {
            background: #4CAF50;
        }

        .status-stopping {
            background: #9e9e9e;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading {
            animation: spin 2s linear infinite;
        }

        .status-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .uptime {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .button {
            padding: 12px 25px;
            margin: 8px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 16px;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .start {
            background: #4CAF50;
            color: white;
        }

        .stop {
            background: #f44336;
            color: white;
        }

        .info {
            background: #2196F3;
            color: white;
        }

        .playit-help {
            background: #ff9800;
            color: white;
        }

        .connection-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .connection-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .connection-type {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .ip-address {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }

        .copy-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        #console {
            background: #000;
            color: #0f0;
            padding: 15px;
            height: 300px;
            overflow-y: scroll;
            font-family: 'Courier New', monospace;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
        }

        #commandInput {
            width: 70%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 14px;
        }



        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .connection-info {
                grid-template-columns: 1fr;
            }

            #commandInput {
                width: 60%;
            }
        }

        /* Dialog Styles */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .dialog-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .dialog-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dialog-header h3 {
            font-size: 1.5em;
            color: #ffd700;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .dialog-body p {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .setup-steps {
            margin-top: 20px;
        }

        .step {
            display: flex;
            margin-bottom: 25px;
            align-items: flex-start;
        }

        .step-number {
            background: #ffd700;
            color: #333;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            margin-bottom: 10px;
            color: #ffd700;
        }

        .step-content h5 {
            margin-bottom: 8px;
            color: #fff;
        }

        .setup-link {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .setup-link:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .tunnel-config {
            margin-top: 15px;
        }

        .tunnel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .tunnel ul {
            list-style: none;
            margin-top: 10px;
        }

        .tunnel li {
            padding: 3px 0;
            padding-left: 15px;
            position: relative;
        }

        .tunnel li:before {
            content: '•';
            color: #ffd700;
            position: absolute;
            left: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Playit Help Button Styles */
        .playit-help-section {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🎮 Minecraft Crossplay Server Manager</h1>
            <p>Java Edition + Bedrock Edition Support | Friends Welcome!</p>
        </div>

        <!-- Server Status Card -->
        <div class="card status-card">
            <div id="statusIndicator" class="status-indicator status-offline">
                ⏹️
            </div>
            <div id="statusText" class="status-text">Server Offline</div>
            <div id="uptime" class="uptime hidden">Uptime: 0s</div>

            <div style="margin-top: 30px;">
                <button id="startBtn" class="button start" onclick="startServer()">🚀 Start Server</button>
                <button id="stopBtn" class="button stop" onclick="stopServer()" disabled>⏹️ Stop Server</button>
                <button class="button info" onclick="refreshStatus()">🔄 Refresh</button>
            </div>
        </div>

        <!-- Connection Information -->
        <div id="connectionInfo" class="card hidden">
            <h3>🌐 Connection Information</h3>
            <div class="connection-info" id="connectionGrid">
                <!-- Dynamic connection cards will be inserted here -->
            </div>

            <!-- NEW: Playit.gg Help Section -->
            <div class="playit-help-section" id="playitHelpSection">
                <p>Need help setting up public access?</p>
                <button class="button playit-help" onclick="openPlayitDialog()">📋 Playit.gg Setup Instructions</button>
            </div>
        </div>

        <!-- Server Controls -->
        <div class="card">
            <h3>🎛️ Server Commands</h3>
            <div>
                <input type="text" id="commandInput" placeholder="Enter server command (e.g., say Hello World)"
                    disabled>
                <button class="button info" onclick="sendCommand()" id="sendBtn" disabled>📤 Send</button>
            </div>
            <div style="margin-top: 15px;">
                <button class="button info" onclick="sendCommand('list')" id="listBtn" disabled>👥 List Players</button>
                <button class="button info" onclick="sendCommand('time set day')" id="dayBtn" disabled>☀️ Set
                    Day</button>
                <button class="button info" onclick="sendCommand('weather clear')" id="weatherBtn" disabled>🌤️ Clear
                    Weather</button>
                <button class="button info" onclick="sendCommand('difficulty easy')" id="diffBtn" disabled>⚙️ Easy
                    Mode</button>
            </div>
        </div>

        <!-- Server Console -->
        <div class="card">
            <h3>📟 Server Console</h3>
            <div id="console"></div>
        </div>
    </div>

    <!-- Playit.gg Setup Dialog -->
    <div id="playitDialog" class="dialog-overlay hidden">
        <div class="dialog-content">
            <!-- NEW: Close Button -->
            <button class="close-btn" onclick="closePlayitDialog()" title="Close">×</button>

            <div class="dialog-header">
                <h3>🌐 Playit.gg Setup Instructions</h3>
            </div>
            <div class="dialog-body">
                <p>To make your server accessible from anywhere on the internet, you need to set up Playit.gg tunnels:
                </p>

                <div class="setup-steps">
                    <div class="step">
                        <span class="step-number">1</span>
                        <div class="step-content">
                            <h4>Sign in to Playit.gg</h4>
                            <p>Click the link below to sign in and claim your agent:</p>
                            <a id="playitSetupLink" href="https://playit.gg" target="_blank" class="setup-link">
                                🔗 Setup Playit.gg Agent
                            </a>
                        </div>
                    </div>

                    <div class="step">
                        <span class="step-number">2</span>
                        <div class="step-content">
                            <h4>Create 2 Tunnels</h4>
                            <div class="tunnel-config">
                                <div class="tunnel">
                                    <h5>📱 Tunnel 1 - Java Edition:</h5>
                                    <ul>
                                        <li><strong>Protocol:</strong> TCP</li>
                                        <li><strong>Local Port:</strong> 25565</li>
                                        <li><strong>Name:</strong> Minecraft Java</li>
                                    </ul>
                                </div>
                                <div class="tunnel">
                                    <h5>🎯 Tunnel 2 - Bedrock Edition:</h5>
                                    <ul>
                                        <li><strong>Protocol:</strong> UDP</li>
                                        <li><strong>Local Port:</strong> 19132</li>
                                        <li><strong>Name:</strong> Minecraft Bedrock</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="step">
                        <span class="step-number">3</span>
                        <div class="step-content">
                            <h4>Wait for Activation</h4>
                            <p>Once you've created the tunnels, they will automatically appear in the connection
                                information above.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let currentStatus = 'offline';
        let previousStatus = null;
        let statusCheckInterval;
        let lastLoggedUptime = 0;
        let connectionInfoShown = false;
        let socket;

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();

            socket.on('connect', () => {
                log('🔗 Connected to server for real-time logs', 'success');
            });

            socket.on('disconnect', () => {
                log('❌ Disconnected from server', 'error');
            });

            socket.on('new-log', (logEntry) => {
                displayLog(logEntry);
            });

            socket.on('recent-logs', (logs) => {
                logs.forEach(logEntry => {
                    displayLog(logEntry, false);
                });
            });

            // REMOVED: No more 'playit-dialog' socket listener
        }

        // Manual dialog control only
        function openPlayitDialog() {
            // Get the current setup URL from server status
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const setupLink = document.getElementById('playitSetupLink');
                    if (data.playit && data.playit.setupUrl) {
                        setupLink.href = data.playit.setupUrl;
                    } else {
                        setupLink.href = 'https://playit.gg';
                    }
                    document.getElementById('playitDialog').classList.remove('hidden');
                })
                .catch(error => {
                    // Fallback to generic playit.gg link
                    document.getElementById('playitSetupLink').href = 'https://playit.gg';
                    document.getElementById('playitDialog').classList.remove('hidden');
                });
        }

        function closePlayitDialog() {
            document.getElementById('playitDialog').classList.add('hidden');
        }

        // Display log entry with color coding
        function displayLog(logEntry, shouldScroll = true) {
            const console = document.getElementById('console');
            let color = '#0f0';
            let icon = '';

            switch (logEntry.type) {
                case 'error':
                    color = '#ff4444';
                    icon = '❌';
                    break;
                case 'warn':
                    color = '#ffaa00';
                    icon = '⚠️';
                    break;
                case 'success':
                    color = '#44ff44';
                    icon = '✅';
                    break;
                case 'player':
                    color = '#44aaff';
                    icon = '👤';
                    break;
                case 'world':
                    color = '#aa44ff';
                    icon = '🌍';
                    break;
                case 'info':
                default:
                    color = '#0f0';
                    icon = 'ℹ️';
                    break;
            }

            const logElement = document.createElement('div');
            logElement.innerHTML = `
            <span style="color: #888">[${logEntry.time}]</span> 
            <span style="color: ${color}">${icon} ${logEntry.message}</span>
        `;

            console.appendChild(logElement);

            while (console.children.length > 500) {
                console.removeChild(console.firstChild);
            }

            if (shouldScroll) {
                console.scrollTop = console.scrollHeight;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeSocket();
            startStatusCheck();
        });

        async function startServer() {
            try {
                const response = await fetch('/start', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    log(`🚀 ${data.message}`, 'success');
                    updateUI('starting');
                } else {
                    log(`❌ ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ Error starting server: ${error.message}`, 'error');
            }
        }

        async function stopServer() {
            try {
                const response = await fetch('/stop', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    log(`⏹️ ${data.message}`, 'info');
                    updateUI('stopping');
                } else {
                    log(`❌ ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ Error stopping server: ${error.message}`, 'error');
            }
        }

        async function sendCommand(cmd = null) {
            const command = cmd || document.getElementById('commandInput').value;
            if (!command) return;

            try {
                const response = await fetch('/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });

                const data = await response.json();
                if (data.success) {
                    log(`📤 ${data.message}`, 'info');
                    if (!cmd) document.getElementById('commandInput').value = '';
                } else {
                    log(`❌ ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ Error sending command: ${error.message}`, 'error');
            }
        }

        async function refreshStatus() {
            log('🔄 Manually refreshing status...', 'info');
            await checkStatus(true);
        }

        async function checkStatus(forceLog = false) {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                const statusChanged = data.status !== previousStatus;

                if (statusChanged || forceLog) {
                    handleStatusChange(data.status, data, statusChanged);
                }

                updateUI(data.status, data);

                if (data.status === 'online' && data.connections) {
                    updateConnectionInfo(data.connections, data.publicIP, data);
                }

                previousStatus = data.status;

            } catch (error) {
                if (forceLog) {
                    log(`❌ Status check failed: ${error.message}`, 'error');
                }
                console.error('Status check failed:', error);
            }
        }

        function handleStatusChange(newStatus, data, statusChanged) {
            switch (newStatus) {
                case 'offline':
                    if (statusChanged) {
                        log('⏹️ Server is now OFFLINE', 'info');
                        connectionInfoShown = false;
                        // Close dialog when server goes offline
                        closePlayitDialog();
                    }
                    break;

                case 'starting':
                    if (statusChanged) {
                        log('⚡ Server is STARTING UP...', 'info');
                    }
                    break;

                case 'online':
                    if (statusChanged) {
                        log('🎉 SERVER IS NOW ONLINE! Friends can join!', 'success');
                        connectionInfoShown = true;
                    }
                    break;

                case 'stopping':
                    if (statusChanged) {
                        log('⏸️ Server is STOPPING...', 'info');
                    }
                    break;
            }
        }

        function updateUI(status, data = null) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            const uptime = document.getElementById('uptime');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const commandBtns = ['sendBtn', 'listBtn', 'dayBtn', 'weatherBtn', 'diffBtn'];
            const commandInput = document.getElementById('commandInput');

            currentStatus = status;
            indicator.className = 'status-indicator';

            switch (status) {
                case 'offline':
                    indicator.classList.add('status-offline');
                    indicator.innerHTML = '⏹️';
                    text.textContent = 'Server Offline';
                    uptime.classList.add('hidden');
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    commandInput.disabled = true;
                    commandBtns.forEach(id => document.getElementById(id).disabled = true);
                    document.getElementById('connectionInfo').classList.add('hidden');
                    break;

                case 'starting':
                    indicator.classList.add('status-starting', 'loading');
                    indicator.innerHTML = '⚡';
                    text.textContent = 'Server Starting...';
                    uptime.classList.remove('hidden');
                    if (data) uptime.textContent = `Starting for ${data.uptime}s`;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    commandInput.disabled = true;
                    commandBtns.forEach(id => document.getElementById(id).disabled = true);
                    break;

                case 'online':
                    indicator.classList.add('status-online');
                    indicator.innerHTML = '✅';
                    text.textContent = 'Server Online';
                    uptime.classList.remove('hidden');
                    if (data) uptime.textContent = `Uptime: ${formatUptime(data.uptime)}`;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    commandInput.disabled = false;
                    commandBtns.forEach(id => document.getElementById(id).disabled = false);
                    document.getElementById('connectionInfo').classList.remove('hidden');
                    break;

                case 'stopping':
                    indicator.classList.add('status-stopping');
                    indicator.innerHTML = '⏸️';
                    text.textContent = 'Server Stopping...';
                    uptime.classList.add('hidden');
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                    commandInput.disabled = true;
                    commandBtns.forEach(id => document.getElementById(id).disabled = true);
                    break;
            }
        }

        function updateConnectionInfo(connections, publicIP, data = null) {
            const grid = document.getElementById('connectionGrid');

            let html = '';

            // Local connections
            html += createConnectionCard('🏠 Local Access', 'For you on this computer', [
                { label: 'Java Edition', address: connections.local.java },
                { label: 'Bedrock Edition', address: connections.local.bedrock }
            ]);

            // Network connections
            html += createConnectionCard('🏘️ Network Access', 'For devices on your WiFi', [
                { label: 'Java Edition', address: connections.network.java },
                { label: 'Bedrock Edition', address: connections.network.bedrock }
            ]);

            // Playit.gg connections
            if (data && data.playit && data.playit.installed) {
                if (data.playit.addresses.java || data.playit.addresses.bedrock) {
                    const playitConnections = [];
                    if (data.playit.addresses.java) {
                        playitConnections.push({ label: 'Java Edition', address: data.playit.addresses.java });
                    }
                    if (data.playit.addresses.bedrock) {
                        playitConnections.push({ label: 'Bedrock Edition', address: data.playit.addresses.bedrock });
                    }
                    html += createConnectionCard('🌐 Public Access (Playit.gg)', 'For friends anywhere on the internet', playitConnections);
                } else {
                    html += createConnectionCard('🌐 Public Access (Playit.gg)', 'Setting up tunnels...', [
                        { label: 'Status', address: 'Tunnels are being created...' }
                    ]);
                }
            } else {
                html += createConnectionCard('🌐 Public Access (Playit.gg)', 'Not available', [
                    { label: 'Status', address: '❌ Playit.gg not installed' },
                    { label: 'Download from', address: 'https://playit.gg/download' }
                ]);
            }

            grid.innerHTML = html;
        }

        function createConnectionCard(title, subtitle, connections) {
            let connectionsHtml = connections.map(conn =>
                `<div class="connection-type">${conn.label}:</div>
             <div class="ip-address">
                 ${conn.address}
                 <button class="copy-btn" onclick="copyToClipboard('${conn.address}')">📋 Copy</button>
             </div>`
            ).join('');

            return `
            <div class="connection-card">
                <h4>${title}</h4>
                <p style="opacity: 0.8; margin-bottom: 15px;">${subtitle}</p>
                ${connectionsHtml}
            </div>
        `;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                log(`📋 Copied to clipboard: ${text}`, 'success');
            }).catch(err => {
                log(`❌ Failed to copy: ${err.message}`, 'error');
            });
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }

        function startStatusCheck() {
            log('🎮 Minecraft Server Manager loaded', 'success');
            log('📡 Checking initial server status...', 'info');
            checkStatus(true);
            statusCheckInterval = setInterval(() => checkStatus(false), 2000);
        }

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();

            let color = '#0f0';
            switch (type) {
                case 'error': color = '#ff4444'; break;
                case 'warn': color = '#ffaa00'; break;
                case 'success': color = '#44ff44'; break;
                case 'info': default: color = '#0f0'; break;
            }

            const logElement = document.createElement('div');
            logElement.innerHTML = `<span style="color: #888">[${timestamp}]</span> <span style="color: ${color}">${message}</span>`;
            console.appendChild(logElement);

            while (console.children.length > 500) {
                console.removeChild(console.firstChild);
            }

            console.scrollTop = console.scrollHeight;
        }

        startStatusCheck();

        document.getElementById('commandInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !this.disabled) {
                sendCommand();
            }
        });

        // Close dialog when clicking outside
        document.getElementById('playitDialog').addEventListener('click', function (e) {
            if (e.target === this) {
                closePlayitDialog();
            }
        });
    </script>

</body>

</html>